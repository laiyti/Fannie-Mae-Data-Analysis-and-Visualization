---
title: "test"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
# Selecting only numeric variables
selected_variables <- yr2007Q4 %>%
  select_if(is.numeric)

# Excluding LOAN_ID if present
if ("LOAN_ID" %in% names(yr2007Q4)) {
  selected_variables <- selected_variables %>%
    select(-LOAN_ID)
}

selected_variables <- selected_variables %>%
  mutate(LOAN_ID = as.numeric(LOAN_ID))

# Create data_hm to store correlation data
data_hm <- selected_variables %>%
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Var1") %>% 
  pivot_longer(-Var1, 
               names_to = "Variable", values_to = "corr")

# Filter out rows and columns where either Var1 or Variable is LOAN_ID
data_hm <- data_hm %>%
  filter(!(Var1 == "LOAN_ID" | Variable == "LOAN_ID"))

# Create a heatmap
heatmap <- data_hm %>%
  ggplot(aes(x = Var1, y = Variable, fill = corr)) + 
  geom_tile() +
  theme_minimal()

# Improve the chart 
heatmap_q2 <- heatmap +
  labs(x = "Variables", y = "Variables", title = "") +
  theme(axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
        axis.title.y = element_text(face = "bold", margin = margin(t = 10)),
        axis.text = element_text(size = 5)) +
  scale_fill_gradient2(name = "Correlation", midpoint = 0, limits = c(-1, 1),
                       low = "#ffd200", mid = "white", high = "#e21833")

heatmap_q2

```

```{r}
# Selecting only numeric variables
selected_variables_2 <- selected_variables %>%
  select(LOAN_AGE, ORIG_RATE, CURR_RATE, ORIG_UPB, ORIG_TERM, OLTV, OCLTV, DTI, CSCORE_B, DEFAULT_FLAG)

selected_variables_2 <- na.omit(selected_variables_2)

# Create data_hm to store correlation data
data_hm_2 <- selected_variables_2 %>%
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Var1") %>% 
  pivot_longer(-Var1, 
               names_to = "Variable", values_to = "corr")

# Filter out rows and columns where either Var1 or Variable is LOAN_ID
data_hm <- data_hm %>%
  filter(!(Var1 == "LOAN_ID" | Variable == "LOAN_ID"))

# Create a heatmap
heatmap_2 <- data_hm_2 %>%
  ggplot(aes(x = Var1, y = Variable, fill = corr)) + 
  geom_tile() +
  theme_minimal()

# Improve the chart 
heatmap_2 <- heatmap_2 +
  labs(x = "Variables", y = "Variables", title = "") +
  theme(axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
        axis.title.y = element_text(face = "bold", margin = margin(t = 10)),
        axis.text = element_text(size = 5)) +
  scale_fill_gradient2(name = "Correlation", midpoint = 0, limits = c(-1, 1),
                       low = "#ffd200", mid = "white", high = "#e21833")

heatmap_2

```


## yr2019Q4
```{r}
# Selecting only numeric variables
selected_variables_2019 <- yr2019Q4 %>%
  select_if(is.numeric)
  
selected_variables_2019 <- selected_variables_2019 %>%
  select(LOAN_AGE, ORIG_RATE, CURR_RATE, ORIG_UPB, ORIG_TERM, OLTV, OCLTV, DTI, CSCORE_B, DEFAULT_FLAG) %>%
  mutate(LOAN_ID = as.numeric(LOAN_ID))


selected_variables_2019 <- na.omit(selected_variables_2019)

# Create data_hm to store correlation data
data_hm_2019 <- selected_variables_2019 %>%
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Var1") %>% 
  pivot_longer(-Var1, 
               names_to = "Variable", values_to = "corr")

# Filter out rows and columns where either Var1 or Variable is LOAN_ID
data_hm_2019 <- data_hm_2019 %>%
  filter(!(Var1 == "LOAN_ID" | Variable == "LOAN_ID"))

# Create a heatmap
heatmap_2019 <- data_hm_2019 %>%
  ggplot(aes(x = Var1, y = Variable, fill = corr)) + 
  geom_tile() +
  theme_minimal()

# Improve the chart 
heatmap_2019 <- heatmap_2019 +
  labs(x = "Variables", y = "Variables", title = "") +
  theme(axis.title.x = element_text(face = "bold", margin = margin(t = 10)),
        axis.title.y = element_text(face = "bold", margin = margin(t = 10)),
        axis.text = element_text(size = 5)) +
  scale_fill_gradient2(name = "Correlation", midpoint = 0, limits = c(-1, 1),
                       low = "#ffd200", mid = "white", high = "#e21833")

heatmap_2019
```


```{r}
# calculate the default rate within a specific group of loans
# 2007
yr2007Q4_ftr %>%
  group_by(CHANNEL) %>%
  summarise(default_rate = mean(DEFAULT_FLAG, na.rm = TRUE))

# 2019
yr2019Q4_ftr %>%
  group_by(CHANNEL) %>%
  summarise(default_rate = mean(DEFAULT_FLAG, na.rm = TRUE))
```
```{r}
yr2007Q4 %>%
  mutate(DEFAULT_FLAG = as.factor(DEFAULT_FLAG)) %>%
  select(DEFAULT_FLAG, CSCORE_B) %>%
  filter(DEFAULT_FLAG == 0) %>%
  ggplot(aes(x = CSCORE_B, y = DEFAULT_FLAG)) +
  geom_boxplot(fill = "#e21833", alpha = 0.5, width = 0.3) + 
  geom_jitter(width = 0.05, col = "#ffd200", alpha = 0.5, size = 2) + 
  xlim(-0.5, 0.5) +
  labs(title="", x="" , y="default_flag") +
  #geom_text(x = 0.21, y = 16, label = 'Median = 16', size=3, col = 'grey18') +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.grid.major.y = element_line(color="grey85"),
        panel.grid.minor.y = element_line(color="grey95"))
```
```{r}
yr2007Q4_ftr %>%
  filter(DEFAULT_FLAG == 1, na.rm = TRUE) %>%
  ggplot(aes(x = DTI, y = CSCORE_B, color = DEFAULT_FLAG)) +
  geom_point(stroke=NA, alpha=0.8, size = 2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 2, col='black', lwd = 0.5) +
  labs(title="",
       x="") +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        panel.grid.major.y = element_line(color="grey95")) 

yr2007Q4_ftr %>%
  filter(DEFAULT_FLAG == 0, na.rm = TRUE) %>%
  ggplot(aes(x = DTI, y = CSCORE_B, color = DEFAULT_FLAG)) +
  geom_point(stroke=NA, alpha=0.8, size = 2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 2, col='black', lwd = 0.5) +
  labs(title="",
       x="") +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        panel.grid.major.y = element_line(color="grey95")) 
```
```{r}
yr2019Q4_ftr %>%
  filter(DEFAULT_FLAG == 1, na.rm = TRUE) %>%
  ggplot(aes(x = DTI, y = CSCORE_B, color = DEFAULT_FLAG)) +
  geom_point(stroke=NA, alpha=0.8, size = 2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 2, col='black', lwd = 0.5) +
  labs(title="",
       x="") +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        panel.grid.major.y = element_line(color="grey95"))

yr2019Q4_ftr %>%
  filter(DEFAULT_FLAG == 0, na.rm = TRUE) %>%
  ggplot(aes(x = DTI, y = CSCORE_B, color = DEFAULT_FLAG)) +
  geom_point(stroke=NA, alpha=0.8, size = 2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 2, col='black', lwd = 0.5) +
  labs(title="",
       x="") +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank()) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        panel.grid.major.y = element_line(color="grey95"))
```
```{r}
dr_state_2007 <- yr2007Q4 %>%
  mutate(STATE = as.factor(STATE)) %>%
  group_by(STATE) %>%
  summarise(default_rate = mean(DEFAULT_FLAG),
            count = n(),
            avg_dti = mean(DTI, na.rm = TRUE),
            avg_cscore = mean(CSCORE_B, na.rm = TRUE)) %>%
  arrange(-default_rate)

dr_state_2007
```

```{r}
dr_state_2019 <- yr2019Q4 %>%
  mutate(STATE = as.factor(STATE)) %>%
  group_by(STATE) %>%
  summarise(default_rate = mean(DEFAULT_FLAG),
            count = n(),
            avg_dti = mean(DTI, na.rm = TRUE),
            avg_cscore = mean(CSCORE_B, na.rm = TRUE)) %>%
  arrange(-default_rate)

dr_state_2019
```
```{r}
# prepare the data
default_rate_season <- default_rate_ts %>%
  mutate(Date = as.Date(Date, "%m/%d/%Y"),
         year = as.factor(year(Date)), 
         yearqrt = as.factor(as.yearqtr(Date))) %>%
  select(-...3, -...4, -...5, -...6) %>%
  arrange(-`Default rate`)

default_rate_season
```

```{r}
default_rate_season %>%
  ggplot(aes(x = yearqrt, y = `Default rate`)) + 
  geom_col() + 
  # add a reference line to denote the average gross
  geom_hline(yintercept = mean(default_rate_season$`Default rate`),lty = 2) +
  #geom_text(x = "2019 Q2", y = 315, label = 'Average', size = 5) +
  theme_classic() + 
  labs(x = '', y = 'Defalut rate') + 
  theme(axis.text = element_text(face="bold",size=5),
        axis.title = element_text(face="bold",size=15),
        legend.position = "none",
        axis.title.x = element_text(margin = margin(t=10)),
        legend.text = element_text(face="bold",size=15),
        legend.title = element_text(face="bold",size=15),
        panel.grid.major.y = element_line(color="grey85"))
  #scale_fill_manual(values = c('pink','lightyellow','lightblue'))
  #scale_x_discrete(breaks = c("2017 Q1","2018 Q1","2019 Q1"))
```
```{r}
default_rate_season %>%
  filter(year %in%  c(2007, 2008, 2009, 2010))%>%
  ggplot(aes(x = yearqrt, y = `Default rate`)) + 
  geom_col(fill = "#05314D") + #"#05314D" is Fannie Mae's color
  geom_hline(yintercept = mean(default_rate_season$`Default rate`),lty = 2) +
  theme_classic() + 
  labs(x = "", y = 'Defalut rate') + 
  theme(axis.text = element_text(face="bold",size=6),
        axis.title = element_text(face="bold",size=15), 
        panel.grid.major.y = element_line(color="grey85"))

default_rate_season %>%
  filter(year %in%  c(2019, 2020, 2021, 2022))%>%
  ggplot(aes(x = yearqrt, y = `Default rate`)) + 
  geom_col(fill = "#05314D") + 
  geom_hline(yintercept = mean(default_rate_season$`Default rate`),lty = 2) +
  theme_classic() + 
  labs(x="",y = 'Defalut rate') + 
  theme(axis.text = element_text(face="bold",size=6),
        axis.title = element_text(face="bold",size=15),
        panel.grid.major.y = element_line(color="grey85"))
```
```{r}
pair_data <- kc_house1 %>%
  filter(condition >= 3) %>%
  select(condition, sqft_living, sqft_lot, sqft_living15, price)%>%
  mutate(condition = as.factor(condition)) %>% # change "condition" to a categorical variable
  mutate(condition = stringr::str_replace(condition, "3", "Average")) %>%
  mutate(condition = stringr::str_replace(condition, "4", "Good")) %>%
  mutate(condition = stringr::str_replace(condition, "5", "Very good"))

pair_data %>%
  ggpairs(aes(col=condition,alpha = 0.4)) + # alpha sets the opacity of a geom
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
{r}
# Define the x-axis limits for the box
x_limits <- c(2007.5, 2007.5)

# Define the y-axis limits for the box
y_limits <- c(0, max(default_rate_season$`Default rate`))

default_rate_season %>%
  ggplot(aes(x = yearqrt, y = `Default rate`)) + 
  geom_col(fill = "#05314D") + #"#05314D" is Fannie Mae's color
  geom_hline(yintercept = mean(default_rate_season$`Default rate`), lty = 2, col = "red3") +
  geom_text(x = "2020 Q3", y = 0.019, label = 'Average default rate', size=4, col = 'black') +
  theme_classic() + 
  labs(x = "", y = 'Defalut rate') + 
  theme(axis.text.x = element_text(face = "bold", size = 6, angle = 90, vjust = 0.5),
        axis.title = element_text(face="bold",size=10), 
        panel.grid.major.y = element_line(color="grey85")) +
  geom_rect(xmin = x_limits[1], xmax = x_limits[2], ymin = y_limits[1], ymax = y_limits[2],
            fill = NA, color = "red", size = 1.5, linetype = "dashed", alpha = 0.7)
```

```{r}
{r}
yr2007Q4_test <- yr2007Q4 %>%
  group_by(DEFAULT_FLAG) %>%
  mutate(quantile_rank = ntile(DTI, 4),
         grouped_rank = as.factor(ifelse(quantile_rank == 4, "YES", "NO")))
```

```{r}
summary(yr2007Q4$DTI)
check <- table(yr2007Q4$DEFAULT_FLAG, yr2007Q4$DTI)
prop.table(check, 2)
barplot(check, legend.text = rownames(check))
barplot(prop.table(check, 2), legend.text = rownames(check))
```

```{r the label of your chart, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="the caption of your chart"}
# Guideline questions
#Calculate the default rate within a specific group of loans (e.g., loans with occupation status 'Principal' 
dr_OCCT_2007 <- yr2007Q4 %>%
  group_by(OCC_STAT) %>%
  summarise(default_rate = mean(DEFAULT_FLAG == 1), 
            count = n(), 
            num_def = sum(DEFAULT_FLAG == 1))

dr_OCCT_2019 <- yr2019Q4 %>%
  group_by(OCC_STAT) %>%
  summarise(default_rate = mean(DEFAULT_FLAG == 1),
            count = n(),
            num_def = sum(DEFAULT_FLAG == 1))


##loans from borrowers with a credit score of 700) by averaging the 'DEFAULT_FLAG' variable, which is
###equivalent to the number of default loans divided by the total number of loans in that group.

df_cr_2007 <- yr2007Q4 %>%
  mutate(cr_gt_700 = ifelse(CSCORE_B > 700, 1, 0)) %>%
  group_by(cr_gt_700) %>%
  summarise(mean(DEFAULT_FLAG == 1))

#If a categorical variable has too many levels, consider grouping them into fewer levels.


#You can refer to news articles or reports to support your conclusions, spark your topic, or convince your
##readers of your topicâ€™s significance. Make sure that you include the reference in the report if you choose
###to do so. Please note that the use of other online resources, such as plots produced by others that are
####accessible online, is not permissible.
```

```{r}
#{r, include = FALSE}
# This is the code block for tasks that do not generate charts, such as loading data, importing packages, data cleaning, and variable manipulation. 
# You can include as many of these blocks as needed. 
# Adding "include = FALSE" will prevent the code block from appearing in the HTML output file.
# You can use "read_rds" to load in the data.
```


```{r}
#{r the label of your chart, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="the caption of your chart"}
# This is the code block for producing charts. 
# You can include as many of these blocks as needed. 
# By adding "echo = FALSE," only the chart and not the code will be included in the output HTML file.
# To modify the size of your chart, adjust the values of fig.width and fig.height.
# Use fig.cap to specify the caption for your chart.
# You can insert a blank line between charts by adding "<br>" below the block.
```

```{r, include = FALSE}
# clean data - 2
# organize the seller
yr2007Q4_ftr <- yr2007Q4_ftr %>%
  mutate(SELLER = case_when(
      SELLER %in% c("Bank Of America, N.A.","Bank of America, N.A.") ~ "Bank Of America, N.A.",
      SELLER %in% c("Citimortgage, Inc.", "CitiMortgage, Inc.") ~ "Citimortgage, Inc.",
      SELLER %in% c("Jpmorgan Chase Bank, National Association", "JPMorgan Chase Bank, National Association") ~ "Jpmorgan Chase Bank, National Association",
      SELLER %in% c("Pnc Bank, N.A.", "PNC Bank, N.A.") ~ "Pnc Bank, N.A.",
      SELLER %in% c("Gmac Mortgage, Llc", "GMAC Mortgage, LLC") ~ "Gmac Mortgage, Llc",
      SELLER %in% c("Wells Fargo Bank, N.A.") ~ "Wells Fargo Bank, N.A.",
      SELLER %in% c("Suntrust Mortgage Inc.") ~ "Suntrust Mortgage Inc.",
      SELLER %in% c("Flagstar Capital Markets Corporation") ~ "Flagstar Capital Markets Corporation",
      SELLER %in% c("Amtrust Bank", "AmTrust Bank") ~ "Amtrust Bank",
      SELLER %in% c("Fdic, Receiver, Indymac Federal Bank Fsb", "FDIC, Receiver, IndyMac Federal Bank FSB") ~ "Fdic, Receiver, Indymac Federal Bank Fsb",
      SELLER %in% c("Truist Bank", "Truist Bank (formerly SunTrust Bank)") ~ "Truist Bank",
      SELLER %in% c("Chase Home Finance, Llc", "Chase Home Finance, LLC") ~ "Chase Home Finance, Llc"),
      SELLER = ifelse(is.na(SELLER), "Other", SELLER),
      SELLER = as.factor(SELLER))
```

```{r the label of your chart, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="test"}
cscore_b_2007 %>% 
  group_by(cscore_group) %>%
  summarise(total_count = n(),
            default_count = sum(DEFAULT_FLAG == 1)) %>%
  ungroup() %>%
  mutate(percent = default_count/total_count) %>%
  mutate(cscore_group = factor(cscore_group, levels = c("No credit score", "Poor", "Fair", "Good", "Very Good", "Exceptional")))
```

```{r the label of your chart, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="test"}
default_rate_season %>%
  ggplot(aes(x = yearqrt, y = `Default rate`)) + 
  geom_col(fill = "#05314D") +
  geom_text(x = "2008 Q3", y = 0.094, label = '2007Q3-2009Q1', size=3, col = 'black') +
  geom_text(x = "2020 Q3", y = 0.013, label = '2019Q3-2021Q1', size=3, col = 'black') +
  theme_classic() + 
  labs(x = "", y = 'Default rate') + 
  theme(axis.text.x = element_text(face = "bold", size = 6, angle = 90, vjust = 0.5),
        axis.title = element_text(face = "bold", size = 10), 
        panel.grid.major.y = element_line(color = "grey85")) +
  geom_rect(xmin = "2007 Q3", xmax = "2009 Q2", ymin = 0, ymax = max(default_rate_season$`Default rate`),
            fill = NA, color = "red3", size = 0.5, linetype = "dashed", alpha = 0.5) +
  geom_rect(xmin = "2019 Q3", xmax = "2021 Q2", ymin = 0, ymax = 0.01,
            fill = NA, color = "red3", size = 0.5, linetype = "dashed", alpha = 0.5)
```
```{r}
cscore_b_2007 %>%
  filter(DEFAULT_FLAG == 1) %>%
  filter(!is.na(CSCORE_B)) %>%
  filter(!is.na(ORIG_RATE)) %>%
  ggplot(aes(x=CSCORE_B,y=ORIG_RATE, color = PURPOSE)) +
  geom_point(stroke=NA, alpha=0.4, size=2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 1) + # se = FALSE will remove intervals around the line.
  labs(caption = "",
       x="Borrower credit score", y="Original interest rate") +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        plot.caption = element_text(face="italic"),
        plot.title = element_text(size=12),
        panel.grid.major.y = element_line(color="grey95")) 
  #scale_color_manual(values = c('royalblue','darkorange','red4')) +
  #scale_x_continuous(breaks = seq(400,900,100))
```
```{r}
cscore_b_2019 %>%
  filter(DEFAULT_FLAG == 1) %>%
  filter(!is.na(CSCORE_B)) %>%
  filter(!is.na(ORIG_RATE)) %>%
  ggplot(aes(x=CSCORE_B,y=ORIG_RATE, color = PURPOSE)) +
  geom_point(stroke=NA, alpha=0.4, size=2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 1) + # se = FALSE will remove intervals around the line.
  labs(caption = "",
       x="Borrower credit score", y="Original interest rate") +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        plot.caption = element_text(face="italic"),
        plot.title = element_text(size=12),
        panel.grid.major.y = element_line(color="grey95")) 
```
```{r}
cscore_b_2007 %>%
  filter(DEFAULT_FLAG == 1) %>%
  group_by(PURPOSE) %>%
  summarise(n = n())

cscore_b_2019 %>%
  filter(DEFAULT_FLAG == 1) %>%
  group_by(PURPOSE) %>%
  summarise(n = n())
```


```{r}
cscore_b_2019 %>%
  filter(DEFAULT_FLAG == 1) %>%
  ggplot(aes(x=CSCORE_B,y=ORIG_RATE, color = PURPOSE)) +
  geom_point(stroke=NA, alpha=0.4, size=2) + 
  geom_smooth(method = "lm", se = FALSE, lty = 1) + # se = FALSE will remove intervals around the line.
  labs(caption = "",
       x="Borrower credit score", y="Original interest rate") +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold",margin = margin(t = 10)),
        axis.text = element_text(face="bold",size=10),
        plot.caption = element_text(face="italic"),
        plot.title = element_text(size=12),
        panel.grid.major.y = element_line(color="grey95")) 
```


```{r}
cscore_b_2007 %>%
  group_by(STATE) %>%
  summarise(avg_origint = mean(ORIG_RATE))

cscore_b_2019 %>%
  group_by(STATE) %>%
  summarise(avg_origint = mean(ORIG_RATE))
```

```{r}
set.seed(1)

cscore_b_2007 %>%
  ggplot(aes(x = 0, y = CSCORE_B)) +
  geom_boxplot(fill = "#e21833", alpha = 0.5, width = 0.3) + 
  #geom_jitter(width = 0.05, col = "#ffd200", alpha = 1, size = 2) + 
  xlim(-0.5, 0.5) +
  labs(title="",
       x="" , y="cscore") +
  #geom_text(x = 0.21, y = 16, label = 'Median = 16', size=3, col = 'grey18') +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.grid.major.y = element_line(color="grey85"),
        panel.grid.minor.y = element_line(color="grey95"))

cscore_b_2019 %>%
  ggplot(aes(x = 0, y = CSCORE_B)) +
  geom_boxplot(fill = "#e21833", alpha = 0.5, width = 0.3) + 
  #geom_jitter(width = 0.05, col = "#ffd200", alpha = 1, size = 2) + 
  xlim(-0.5, 0.5) +
  labs(title="",
       x="" , y="cscore") +
  #geom_text(x = 0.21, y = 16, label = 'Median = 16', size=3, col = 'grey18') +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.grid.major.y = element_line(color="grey85"),
        panel.grid.minor.y = element_line(color="grey95"))
```

```{r}
library(ggplot2)
library(dplyr)

# Combine the data frames
combined_data <- bind_rows(
  mutate(cscore_b_2007, year = 2007),
  mutate(cscore_b_2019, year = 2019)) %>%
  filter(!is.na(CSCORE_B))

# Plot the combined data
combined_data %>%
  ggplot(aes(x = factor(year), y = CSCORE_B, fill = as.factor(year))) +
  geom_boxplot(alpha = 0.5, width = 0.3) +
  scale_fill_manual(values = c("blue", "red"), name = "Year") +
  labs(title = "", x = "Year", y = "Borrower credit score") +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey85"),
        panel.grid.minor.y = element_line(color = "grey95"))

```

```{r}
# Combine the data frames
combined_data <- bind_rows(
  mutate(cscore_b_2007, year = 2007),
  mutate(cscore_b_2019, year = 2019)) %>%
  filter(!is.na(LOAN_AGE))

# Plot the combined data
combined_data %>%
  ggplot(aes(x = factor(year), y = LOAN_AGE, fill = as.factor(year))) +
  geom_boxplot(alpha = 0.5, width = 0.3) +
  scale_fill_manual(values = c("blue", "red"), name = "Year") +
  labs(title = "", x = "Year", y = "Loan age") +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey85"),
        panel.grid.minor.y = element_line(color = "grey95"))
```

```{r}
plot_test <- combined_data %>%
  ggplot(aes(x = factor(year), y = ORIG_UPB, fill = as.factor(year))) +
  geom_boxplot(alpha = 0.5, width = 0.3) +
  scale_fill_manual(values = c("blue", "red"), name = "Year") +
  labs(title = "", x = "Year", y = "Loan age") +
  theme_classic() +
  theme(axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey85"),
        panel.grid.minor.y = element_line(color = "grey95"))

plot_test
```

```{r}
```{r the label of your chart, echo = FALSE, fig.width=10, fig.height = 4, fig.cap="test"}
ts_ani <- default_rate_ts +
  labs(title ='Year_Quarter:{frame_along}',
       subtitle = 'Default rate') +
  transition_reveal(as.numeric(year)) +
  ease_aes('linear')

animate(ts_ani)
```
```

```{r}
default_rate_ts <- default_rate_season %>%
  ggplot(aes(x = yearqrt, y = `Default rate`, group = 1)) + 
  geom_line(col = "lightblue", lwd = 1.5) +
  geom_point(col = "red3", size = 1) +
  theme_classic() + 
  geom_vline(xintercept = "2007 Q4", lty = 2) +
  geom_vline(xintercept = "2019 Q4", lty = 2) +
  labs(x = "", y = 'Default rate') + 
  geom_text(x = "2008 Q4", y = 0.094, label = "2007 Q4", size=4, col = 'black') +
  geom_text(x = "2020 Q4", y = 0.094, label = "2019 Q4", size=4, col = 'black') +
  theme(axis.text.x = element_text(face = "bold", size = 6, angle = 90, vjust = 0.5),
        axis.title = element_text(face = "bold", size = 10), 
        panel.grid.major.y = element_line(color = "grey85"))

default_rate_ts
```

```{r}
cscore_b_2007 %>%
  group_by(cscore_group) %>%
  summarise(total_count = n(),
            default_count = sum(DEFAULT_FLAG == 1)) %>%
  ungroup() %>%
  mutate(percent = default_count / total_count) %>%
  mutate(cscore_group = factor(cscore_group, levels = c("No credit score", "Poor", "Fair", "Good", "Very Good", "Exceptional"))) %>%
  ggplot(aes(x = cscore_group, y = percent)) +
  geom_col(fill = "steelblue", width = 0.7) +
  geom_text(aes(label = scales::percent(round(percent, 4))), size = 3, position = position_stack(vjust = 0.5)) +
  labs(y = "", x = "") +
  theme_minimal() +
  theme(axis.title.x = element_text(face = "bold"), 
        axis.text = element_text(face = "bold", size = 10),
        legend.position = "bottom",
        legend.margin = margin(t = -15),
        plot.caption = element_text(face = "italic"),
        plot.title = element_text(size = 14),
        panel.grid.minor = element_blank(), 
        panel.grid.major.y = element_line(color = "grey90"),
        panel.grid.major.x = element_blank()) +
  scale_fill_brewer(name = "", palette = "Paired")

```

```{r}

```

